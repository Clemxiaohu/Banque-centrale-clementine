<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banque Clémentine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
            font-family: 'Roboto Mono', monospace;
        }
        #app-container {
            position: relative;
            width: 800px;
            height: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        canvas {
            background-color: #fff;
            border-radius: 12px;
        }
        /* Style pour les champs de saisie invisibles */
        .input-hidden {
            position: absolute;
            background: rgba(255, 255, 255, 0);
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            padding: 8px;
            opacity: 0;
        }
        .input-visible {
             opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <canvas id="clementineCanvas"></canvas>
        <input type="text" id="passportInput" class="input-hidden">
        <input type="password" id="passwordInput" class="input-hidden">
        <input type="text" id="usernameInput" class="input-hidden">
        <input type="text" id="createPassportInput" class="input-hidden">
        <input type="password" id="createPasswordInput" class="input-hidden">
        <input type="number" id="createBalanceInput" class="input-hidden">
        <input type="text" id="targetPassportInput" class="input-hidden">
        <input type="number" id="adminAmountInput" class="input-hidden">
        <input type="text" id="recipientPassportInput" class="input-hidden">
        <input type="number" id="transferAmountInput" class="input-hidden">
        <input type="number" id="userAmountInput" class="input-hidden">
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // La configuration Firebase est directement intégrée
        const firebaseConfig = {
            apiKey: "AIzaSyANuDNJEiPPzBqmmZIhG4Gklyqzt6OX0Lw",
            authDomain: "banque-clementine.firebaseapp.com",
            projectId: "banque-clementine",
            storageBucket: "banque-clementine.firebasestorage.app",
            messagingSenderId: "191578816921",
            appId: "1:191578816921:web:2cd3941388d6c124129308",
            measurementId: "G-699M789NPK"
        };
        
        const ADMIN_ID = "00001";
        const ADMIN_PASSWORD = "Le poulet c'est trop bon !";
        const MESSAGES = {
            SUCCESS_CREATE: "Compte créé !",
            SUCCESS_UPDATE: "Solde mis à jour !",
            SUCCESS_TRANSFER: "Virement effectué !",
            ERROR_EXISTS: "Ce passeport existe déjà !",
            ERROR_NOT_FOUND: "Passeport introuvable.",
            ERROR_INVALID: "Veuillez vérifier les champs.",
            ERROR_INSUFFICIENT: "Solde insuffisant !",
            ERROR_ADMIN_ID: "Impossible de créer un compte avec le passeport admin.",
            ERROR_PASSWORD_MISMATCH: "Mot de passe incorrect.",
            ERROR_PASSWORD_EMPTY: "Le mot de passe ne peut pas être vide.",
            ERROR_USERNAME_EMPTY: "Veuillez choisir un nom d'utilisateur."
        };

        // Initialisation de Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Références DOM
        const canvas = document.getElementById('clementineCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('app-container');

        // Champs de saisie cachés
        const passportInput = document.getElementById('passportInput');
        const passwordInput = document.getElementById('passwordInput');
        const usernameInput = document.getElementById('usernameInput');
        const createPassportInput = document.getElementById('createPassportInput');
        const createPasswordInput = document.getElementById('createPasswordInput');
        const createBalanceInput = document.getElementById('createBalanceInput');
        const targetPassportInput = document.getElementById('targetPassportInput');
        const adminAmountInput = document.getElementById('adminAmountInput');
        const userAmountInput = document.getElementById('userAmountInput');
        const recipientPassportInput = document.getElementById('recipientPassportInput');
        const transferAmountInput = document.getElementById('transferAmountInput');

        // État de l'application
        let appState = 'login';
        let currentUserId = null;
        let isAdmin = false;
        let citizens = [];
        let message = '';
        let messageTimeout = null;
        let activeInput = null;

        // Mise à jour de la taille du canevas
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Fonctions de dessin
        function drawText(text, x, y, font, color, align = 'left') {
            ctx.fillStyle = color;
            ctx.font = font;
            ctx.textAlign = align;
            ctx.fillText(text, x, y);
        }

        function drawButton(text, x, y, width, height, color, textColor) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            drawText(text, x + width / 2, y + height / 2 + 5, 'bold 16px Roboto Mono', textColor, 'center');
        }

        function drawInputBox(text, x, y, width, height, active, isPassword = false) {
            ctx.fillStyle = active ? '#fff' : '#f0f0f0';
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = active ? '#6b7280' : '#d1d5db';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            const displayedText = isPassword ? text.replace(/./g, '*') : text;
            drawText(displayedText, x + 10, y + height / 2 + 5, '16px Roboto Mono', '#1f2937');
        }

        // --- Fonctions de dessin d'écran ---

        function drawLoginScreen() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            drawText("BANQUE CLÉMENTINE", centerX, centerY - 150, 'bold 36px Roboto Mono', '#ffb74d', 'center');
            drawText("ENTREZ VOS IDENTIFIANTS", centerX, centerY - 100, '18px Roboto Mono', '#4b5563', 'center');

            drawInputBox(passportInput.value || "Numéro de Passeport", centerX - 150, centerY - 40, 300, 40, activeInput === passportInput);
            drawInputBox(passwordInput.value || "Mot de passe", centerX - 150, centerY + 20, 300, 40, activeInput === passwordInput, true);
            drawButton("ACCÉDER", centerX - 75, centerY + 80, 150, 40, '#ffb74d', '#fff');
            
            if (message) {
                drawText(message, centerX, centerY + 140, '16px Roboto Mono', '#ef4444', 'center');
            }
        }

        function drawUsernameScreen() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            drawText("BIENVENUE !", centerX, centerY - 100, 'bold 36px Roboto Mono', '#2563eb', 'center');
            drawText("Veuillez choisir un nom d'utilisateur.", centerX, centerY - 50, '18px Roboto Mono', '#4b5563', 'center');
            drawInputBox(usernameInput.value || "Nom d'utilisateur", centerX - 150, centerY + 10, 300, 40, activeInput === usernameInput);
            drawButton("CONFIRMER", centerX - 75, centerY + 70, 150, 40, '#22c55e', '#fff');
            
            if (message) {
                drawText(message, centerX, centerY + 130, '16px Roboto Mono', '#ef4444', 'center');
            }
        }

        function drawDashboard() {
            // Zone solde personnel
            drawText("MON COMPTE", 50, 60, 'bold 24px Roboto Mono', '#ffb74d');
            const user = citizens.find(c => c.passportId === currentUserId);
            if (user) {
              drawText(`Passeport : ${currentUserId}`, 50, 95, '14px Roboto Mono', '#4b5563');
              drawText(`Nom d'utilisateur : ${user.username || 'Non défini'}`, 50, 120, '14px Roboto Mono', '#4b5563');
              drawText(`${user.balance.toFixed(2)} Credix`, 50, 180, 'bold 48px Roboto Mono', '#ffb74d');
            }

            // Zone utilisateur standard
            if (!isAdmin) {
                drawText("Faire un virement", 50, 250, '18px Roboto Mono', '#1f2937');
                drawInputBox(recipientPassportInput.value || "Passeport du destinataire", 50, 270, 200, 35, activeInput === recipientPassportInput);
                drawInputBox(transferAmountInput.value || "Montant", 260, 270, 100, 35, activeInput === transferAmountInput);
                drawButton("Virer", 370, 270, 80, 35, '#2563eb', '#fff');
                drawText("Retirer de mon compte", 50, 330, '18px Roboto Mono', '#1f2937');
                drawInputBox(userAmountInput.value || "Montant", 50, 350, 200, 35, activeInput === userAmountInput);
                drawButton("Retirer", 260, 350, 100, 35, '#ef4444', '#fff');
            }

            // Classement public
            drawText("CLASSEMENT DES CITOYENS", canvas.width - 50, 60, 'bold 24px Roboto Mono', '#1f2937', 'right');
            
            citizens.slice().sort((a, b) => b.balance - a.balance).forEach((citizen, index) => {
                const isCurrentUser = citizen.passportId === currentUserId;
                const y = 90 + index * 25;
                const color = isCurrentUser ? '#ffb74d' : '#4b5563';
                drawText(`${citizen.username || citizen.passportId}: ${citizen.balance.toFixed(2)} Credix`, canvas.width - 50, y, '16px Roboto Mono', color, 'right');
            });
            
            // Panneau d'administration
            if (isAdmin) {
                drawText("PANNEAU D'ADMINISTRATION", 50, 350, 'bold 24px Roboto Mono', '#2563eb');
                
                // Créer un compte
                drawText("Créer un nouveau compte", 50, 390, '16px Roboto Mono', '#1f2937');
                drawInputBox(createPassportInput.value || "Nouveau passeport", 50, 410, 150, 35, activeInput === createPassportInput);
                drawInputBox(createPasswordInput.value || "Mot de passe", 210, 410, 150, 35, activeInput === createPasswordInput, true);
                drawInputBox(createBalanceInput.value || "Solde", 370, 410, 100, 35, activeInput === createBalanceInput);
                drawButton("Créer", 480, 410, 80, 35, '#2563eb', '#fff');

                // Gérer un compte existant
                drawText("Gérer un compte existant", 50, 470, '16px Roboto Mono', '#1f2937');
                drawInputBox(targetPassportInput.value || "Passeport du citoyen", 50, 490, 150, 35, activeInput === targetPassportInput);
                drawInputBox(adminAmountInput.value || "Montant", 210, 490, 100, 35, activeInput === adminAmountInput);
                drawButton("Ajouter", 320, 490, 80, 35, '#22c55e', '#fff');
                drawButton("Retirer", 410, 490, 80, 35, '#ef4444', '#fff');
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banque Clémentine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
            font-family: 'Roboto Mono', monospace;
        }
        #app-container {
            position: relative;
            width: 800px;
            height: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        canvas {
            background-color: #fff;
            border-radius: 12px;
        }
        /* Style pour les champs de saisie invisibles */
        .input-hidden {
            position: absolute;
            background: rgba(255, 255, 255, 0);
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            padding: 8px;
            opacity: 0;
        }
        .input-visible {
             opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <canvas id="clementineCanvas"></canvas>
        <input type="text" id="passportInput" class="input-hidden">
        <input type="password" id="passwordInput" class="input-hidden">
        <input type="text" id="usernameInput" class="input-hidden">
        <input type="text" id="createPassportInput" class="input-hidden">
        <input type="password" id="createPasswordInput" class="input-hidden">
        <input type="number" id="createBalanceInput" class="input-hidden">
        <input type="text" id="targetPassportInput" class="input-hidden">
        <input type="number" id="adminAmountInput" class="input-hidden">
        <input type="text" id="recipientPassportInput" class="input-hidden">
        <input type="number" id="transferAmountInput" class="input-hidden">
        <input type="number" id="userAmountInput" class="input-hidden">
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // La configuration Firebase est directement intégrée
        const firebaseConfig = {
            apiKey: "AIzaSyANuDNJEiPPzBqmmZIhG4Gklyqzt6OX0Lw",
            authDomain: "banque-clementine.firebaseapp.com",
            projectId: "banque-clementine",
            storageBucket: "banque-clementine.firebasestorage.app",
            messagingSenderId: "191578816921",
            appId: "1:191578816921:web:2cd3941388d6c124129308",
            measurementId: "G-699M789NPK"
        };
        
        const ADMIN_ID = "00001";
        const ADMIN_PASSWORD = "Le poulet c'est trop bon !";
        const MESSAGES = {
            SUCCESS_CREATE: "Compte créé !",
            SUCCESS_UPDATE: "Solde mis à jour !",
            SUCCESS_TRANSFER: "Virement effectué !",
            ERROR_EXISTS: "Ce passeport existe déjà !",
            ERROR_NOT_FOUND: "Passeport introuvable.",
            ERROR_INVALID: "Veuillez vérifier les champs.",
            ERROR_INSUFFICIENT: "Solde insuffisant !",
            ERROR_ADMIN_ID: "Impossible de créer un compte avec le passeport admin.",
            ERROR_PASSWORD_MISMATCH: "Mot de passe incorrect.",
            ERROR_PASSWORD_EMPTY: "Le mot de passe ne peut pas être vide.",
            ERROR_USERNAME_EMPTY: "Veuillez choisir un nom d'utilisateur."
        };

        // Initialisation de Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Références DOM
        const canvas = document.getElementById('clementineCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('app-container');

        // Champs de saisie cachés
        const passportInput = document.getElementById('passportInput');
        const passwordInput = document.getElementById('passwordInput');
        const usernameInput = document.getElementById('usernameInput');
        const createPassportInput = document.getElementById('createPassportInput');
        const createPasswordInput = document.getElementById('createPasswordInput');
        const createBalanceInput = document.getElementById('createBalanceInput');
        const targetPassportInput = document.getElementById('targetPassportInput');
        const adminAmountInput = document.getElementById('adminAmountInput');
        const userAmountInput = document.getElementById('userAmountInput');
        const recipientPassportInput = document.getElementById('recipientPassportInput');
        const transferAmountInput = document.getElementById('transferAmountInput');

        // État de l'application
        let appState = 'login';
        let currentUserId = null;
        let isAdmin = false;
        let citizens = [];
        let message = '';
        let messageTimeout = null;
        let activeInput = null;

        // Mise à jour de la taille du canevas
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Fonctions de dessin
        function drawText(text, x, y, font, color, align = 'left') {
            ctx.fillStyle = color;
            ctx.font = font;
            ctx.textAlign = align;
            ctx.fillText(text, x, y);
        }

        function drawButton(text, x, y, width, height, color, textColor) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            drawText(text, x + width / 2, y + height / 2 + 5, 'bold 16px Roboto Mono', textColor, 'center');
        }

        function drawInputBox(text, x, y, width, height, active, isPassword = false) {
            ctx.fillStyle = active ? '#fff' : '#f0f0f0';
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = active ? '#6b7280' : '#d1d5db';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            const displayedText = isPassword ? text.replace(/./g, '*') : text;
            drawText(displayedText, x + 10, y + height / 2 + 5, '16px Roboto Mono', '#1f2937');
        }

        // --- Fonctions de dessin d'écran ---

        function drawLoginScreen() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            drawText("BANQUE CLÉMENTINE", centerX, centerY - 150, 'bold 36px Roboto Mono', '#ffb74d', 'center');
            drawText("ENTREZ VOS IDENTIFIANTS", centerX, centerY - 100, '18px Roboto Mono', '#4b5563', 'center');

            drawInputBox(passportInput.value || "Numéro de Passeport", centerX - 150, centerY - 40, 300, 40, activeInput === passportInput);
            drawInputBox(passwordInput.value || "Mot de passe", centerX - 150, centerY + 20, 300, 40, activeInput === passwordInput, true);
            drawButton("ACCÉDER", centerX - 75, centerY + 80, 150, 40, '#ffb74d', '#fff');
            
            if (message) {
                drawText(message, centerX, centerY + 140, '16px Roboto Mono', '#ef4444', 'center');
            }
        }

        function drawUsernameScreen() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            drawText("BIENVENUE !", centerX, centerY - 100, 'bold 36px Roboto Mono', '#2563eb', 'center');
            drawText("Veuillez choisir un nom d'utilisateur.", centerX, centerY - 50, '18px Roboto Mono', '#4b5563', 'center');
            drawInputBox(usernameInput.value || "Nom d'utilisateur", centerX - 150, centerY + 10, 300, 40, activeInput === usernameInput);
            drawButton("CONFIRMER", centerX - 75, centerY + 70, 150, 40, '#22c55e', '#fff');
            
            if (message) {
                drawText(message, centerX, centerY + 130, '16px Roboto Mono', '#ef4444', 'center');
            }
        }

        function drawDashboard() {
            // Zone solde personnel
            drawText("MON COMPTE", 50, 60, 'bold 24px Roboto Mono', '#ffb74d');
            const user = citizens.find(c => c.passportId === currentUserId);
            if (user) {
              drawText(`Passeport : ${currentUserId}`, 50, 95, '14px Roboto Mono', '#4b5563');
              drawText(`Nom d'utilisateur : ${user.username || 'Non défini'}`, 50, 120, '14px Roboto Mono', '#4b5563');
              drawText(`${user.balance.toFixed(2)} Credix`, 50, 180, 'bold 48px Roboto Mono', '#ffb74d');
            }

            // Zone utilisateur standard
            if (!isAdmin) {
                drawText("Faire un virement", 50, 250, '18px Roboto Mono', '#1f2937');
                drawInputBox(recipientPassportInput.value || "Passeport du destinataire", 50, 270, 200, 35, activeInput === recipientPassportInput);
                drawInputBox(transferAmountInput.value || "Montant", 260, 270, 100, 35, activeInput === transferAmountInput);
                drawButton("Virer", 370, 270, 80, 35, '#2563eb', '#fff');
                drawText("Retirer de mon compte", 50, 330, '18px Roboto Mono', '#1f2937');
                drawInputBox(userAmountInput.value || "Montant", 50, 350, 200, 35, activeInput === userAmountInput);
                drawButton("Retirer", 260, 350, 100, 35, '#ef4444', '#fff');
            }

            // Classement public
            drawText("CLASSEMENT DES CITOYENS", canvas.width - 50, 60, 'bold 24px Roboto Mono', '#1f2937', 'right');
            
            citizens.slice().sort((a, b) => b.balance - a.balance).forEach((citizen, index) => {
                const isCurrentUser = citizen.passportId === currentUserId;
                const y = 90 + index * 25;
                const color = isCurrentUser ? '#ffb74d' : '#4b5563';
                drawText(`${citizen.username || citizen.passportId}: ${citizen.balance.toFixed(2)} Credix`, canvas.width - 50, y, '16px Roboto Mono', color, 'right');
            });
            
            // Panneau d'administration
            if (isAdmin) {
                drawText("PANNEAU D'ADMINISTRATION", 50, 350, 'bold 24px Roboto Mono', '#2563eb');
                
                // Créer un compte
                drawText("Créer un nouveau compte", 50, 390, '16px Roboto Mono', '#1f2937');
                drawInputBox(createPassportInput.value || "Nouveau passeport", 50, 410, 150, 35, activeInput === createPassportInput);
                drawInputBox(createPasswordInput.value || "Mot de passe", 210, 410, 150, 35, activeInput === createPasswordInput, true);
                drawInputBox(createBalanceInput.value || "Solde", 370, 410, 100, 35, activeInput === createBalanceInput);
                drawButton("Créer", 480, 410, 80, 35, '#2563eb', '#fff');

                // Gérer un compte existant
                drawText("Gérer un compte existant", 50, 470, '16px Roboto Mono', '#1f2937');
                drawInputBox(targetPassportInput.value || "Passeport du citoyen", 50, 490, 150, 35, activeInput === targetPassportInput);
                drawInputBox(adminAmountInput.value || "Montant", 210, 490, 100, 35, activeInput === adminAmountInput);
                drawButton("Ajouter", 320, 490, 80, 35, '#22c55e', '#fff');
                drawButton("Retirer", 410, 490, 80, 35, '#ef4444', '#fff');
            }

            // Bouton de déconnexion
            drawButton("Déconnexion", 50, canvas.height - 50, 150, 35, '#6b7280', '#fff');
            if (message) {
                drawText(message, 50, canvas.height - 80, '16px Roboto Mono', '#ef4444');
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            switch (appState) {
                case 'login':
                    drawLoginScreen();
                    break;
                case 'set_username':
                    drawUsernameScreen();
                    break;
                case 'user_dashboard':
                case 'admin_dashboard':
                    drawDashboard();
                    break;
            }
        }

        // --- Logique de l'application ---
        let personalBalance = 0;

        async function login() {
            const passportId = passportInput.value.trim();
            const password = passwordInput.value;

            if (!passportId) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }

            // Vérification de l'admin
            if (passportId === ADMIN_ID) {
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    currentUserId = passportId;
                    appState = 'admin_dashboard';
                    localStorage.setItem('currentUserId', passportId);
                    hideAllInputs();
                    draw();
                } else {
                    showMessage(MESSAGES.ERROR_PASSWORD_MISMATCH);
                }
                return;
            }

            // Vérification d'un citoyen
            try {
                const docRef = db.collection("citizens").doc(passportId);
                const doc = await docRef.get();
                if (doc.exists) {
                    const citizenData = doc.data();
                    if (citizenData.password === password) {
                        isAdmin = false;
                        currentUserId = passportId;
                        localStorage.setItem('currentUserId', passportId);
                        hideAllInputs();
                        if (!citizenData.username) {
                            appState = 'set_username';
                        } else {
                            appState = 'user_dashboard';
                        }
                        draw();
                    } else {
                        showMessage(MESSAGES.ERROR_PASSWORD_MISMATCH);
                    }
                } else {
                    showMessage(MESSAGES.ERROR_NOT_FOUND);
                }
            } catch (e) {
                showMessage("Erreur de connexion.");
            }
        }
        
        async function setUsername() {
            const username = usernameInput.value.trim();
            if (!username) {
                showMessage(MESSAGES.ERROR_USERNAME_EMPTY);
                return;
            }
            try {
                await db.collection("citizens").doc(currentUserId).update({ username });
                appState = 'user_dashboard';
                hideAllInputs();
                draw();
            } catch (e) {
                showMessage("Erreur de sauvegarde du nom d'utilisateur.");
            }
        }

        async function createAccount() {
            const newPassport = createPassportInput.value.trim();
            const newPassword = createPasswordInput.value;
            const initialBalance = parseFloat(createBalanceInput.value);

            if (!newPassport || isNaN(initialBalance)) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }
            if (newPassword.length === 0) {
                showMessage(MESSAGES.ERROR_PASSWORD_EMPTY);
                return;
            }
            if(newPassport === ADMIN_ID) {
                showMessage(MESSAGES.ERROR_ADMIN_ID);
                return;
            }

            try {
                const docRef = db.collection("citizens").doc(newPassport);
                const doc = await docRef.get();
                if (doc.exists) {
                    showMessage(MESSAGES.ERROR_EXISTS);
                } else {
                    await docRef.set({ balance: initialBalance, password: newPassword });
                    showMessage(MESSAGES.SUCCESS_CREATE);
                    createPassportInput.value = '';
                    createPasswordInput.value = '';
                    createBalanceInput.value = '500';
                }
            } catch (e) {
                showMessage("Erreur de création.");
            }
        }
        
        async function handleUserBalance(action) {
            const amount = parseFloat(userAmountInput.value);
            if (!currentUserId || isNaN(amount)) return;
            const docRef = db.collection("citizens").doc(currentUserId);
            
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    let newBalance = doc.data().balance;
                    if (action === 'subtract') {
                        if (newBalance - amount < 0) {
                             showMessage(MESSAGES.ERROR_INSUFFICIENT);
                             return;
                        }
                        newBalance -= amount;
                        await docRef.update({ balance: newBalance });
                        showMessage(MESSAGES.SUCCESS_UPDATE);
                    }
                }
            } catch (e) {
                showMessage("Erreur de mise à jour.");
            }
        }

        async function handleTransfer() {
            const senderId = currentUserId;
            const recipientId = recipientPassportInput.value.trim();
            const amount = parseFloat(transferAmountInput.value);

            if (senderId === recipientId || !recipientId || isNaN(amount) || amount <= 0) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }

            const senderRef = db.collection("citizens").doc(senderId);
            const recipientRef = db.collection("citizens").doc(recipientId);

            try {
                await db.runTransaction(async (transaction) => {
                    const senderDoc = await transaction.get(senderRef);
                    if (!senderDoc.exists) {
                        throw new Error(MESSAGES.ERROR_NOT_FOUND);
                    }

                    const newSenderBalance = senderDoc.data().balance - amount;
                    if (newSenderBalance < 0) {
                        throw new Error(MESSAGES.ERROR_INSUFFICIENT);
                    }

                    const recipientDoc = await transaction.get(recipientRef);
                    if (!recipientDoc.exists) {
                        throw new Error(MESSAGES.ERROR_NOT_FOUND);
                    }
                    const newRecipientBalance = recipientDoc.data().balance + amount;

                    transaction.update(senderRef, { balance: newSenderBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });
                });
                showMessage(MESSAGES.SUCCESS_TRANSFER);
                recipientPassportInput.value = '';
                transferAmountInput.value = '';
            } catch (e) {
                showMessage(e.message);
            }
        }

        async function handleAdminBalance(action) {
            const targetPassport = targetPassportInput.value.trim();
            const amount = parseFloat(adminAmountInput.value);
            if (!targetPassport || isNaN(amount)) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }
            
            try {
                const docRef = db.collection("citizens").doc(targetPassport);
                const doc = await docRef.get();
                if (doc.exists) {
                    let newBalance = doc.data().balance;
                    if (action === 'add') {
                        newBalance += amount;
                    } else if (action =            }

            // Bouton de déconnexion
            drawButton("Déconnexion", 50, canvas.height - 50, 150, 35, '#6b7280', '#fff');
            if (message) {
                drawText(message, 50, canvas.height - 80, '16px Roboto Mono', '#ef4444');
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            switch (appState) {
                case 'login':
                    drawLoginScreen();
                    break;
                case 'set_username':
                    drawUsernameScreen();
                    break;
                case 'user_dashboard':
                case 'admin_dashboard':
                    drawDashboard();
                    break;
            }
        }

        // --- Logique de l'application ---
        let personalBalance = 0;

        async function login() {
            const passportId = passportInput.value.trim();
            const password = passwordInput.value;

            if (!passportId) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }

            // Vérification de l'admin
            if (passportId === ADMIN_ID) {
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    currentUserId = passportId;
                    appState = 'admin_dashboard';
                    localStorage.setItem('currentUserId', passportId);
                    hideAllInputs();
                    draw();
                } else {
                    showMessage(MESSAGES.ERROR_PASSWORD_MISMATCH);
                }
                return;
            }

            // Vérification d'un citoyen
            try {
                const docRef = db.collection("citizens").doc(passportId);
                const doc = await docRef.get();
                if (doc.exists) {
                    const citizenData = doc.data();
                    if (citizenData.password === password) {
                        isAdmin = false;
                        currentUserId = passportId;
                        localStorage.setItem('currentUserId', passportId);
                        hideAllInputs();
                        if (!citizenData.username) {
                            appState = 'set_username';
                        } else {
                            appState = 'user_dashboard';
                        }
                        draw();
                    } else {
                        showMessage(MESSAGES.ERROR_PASSWORD_MISMATCH);
                    }
                } else {
                    showMessage(MESSAGES.ERROR_NOT_FOUND);
                }
            } catch (e) {
                showMessage("Erreur de connexion.");
            }
        }
        
        async function setUsername() {
            const username = usernameInput.value.trim();
            if (!username) {
                showMessage(MESSAGES.ERROR_USERNAME_EMPTY);
                return;
            }
            try {
                await db.collection("citizens").doc(currentUserId).update({ username });
                appState = 'user_dashboard';
                hideAllInputs();
                draw();
            } catch (e) {
                showMessage("Erreur de sauvegarde du nom d'utilisateur.");
            }
        }

        async function createAccount() {
            const newPassport = createPassportInput.value.trim();
            const newPassword = createPasswordInput.value;
            const initialBalance = parseFloat(createBalanceInput.value);

            if (!newPassport || isNaN(initialBalance)) {
                showMessage(MESSAGES.ERROR_INVALID);
                return;
            }
            if (newPassword.length === 0) {
